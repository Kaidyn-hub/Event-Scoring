<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard</title>
    <link rel="stylesheet" href="style/scoreboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="top-buttons">
    <button onclick="window.location.href='home.html'" class="btn btn-outline-primary">‚Üê Go Back</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='logout.php'">Logout</button>
</div>

<div class="container text-center">
    <h2 id="eventTitle">Event Scoreboard</h2>
    <table class="table table-bordered text-center">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Participant</th>
                <th>Gold</th>
                <th>Silver</th>
                <th>Bronze</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="scoreboard"></tbody>
    </table>

    <div class="button-container">
        <button class="btn btn-outline-success" onclick="updateAllScores()">Update</button>
        <button class="btn btn-outline-danger" onclick="resetScoreboard()">Reset</button>
        <button class="btn btn-outline-warning" onclick="window.location.href='delete_confirmation.html'">Delete All</button>
    </div>
</div>

<script>
function loadScoreboard() {
    fetch("fetch_scores.php")
    .then(response => response.json())
    .then(data => {
        let tbody = document.getElementById("scoreboard");
        tbody.innerHTML = "";

        data.sort((a, b) => (b.gold - a.gold) || (b.silver - a.silver) || (b.bronze - a.bronze));

        data.forEach((row, index) => {
            let total = parseInt(row.gold) + parseInt(row.silver) + parseInt(row.bronze);
            let tr = `
                <tr data-id="${row.id}">
                    <td>${total > 0 ? index + 1 : "-"}</td>
                    <td>${row.participants}</td>
                    <td><input type="number" class="gold" value="${row.gold}" min="0"></td>
                    <td><input type="number" class="silver" value="${row.silver}" min="0"></td>
                    <td><input type="number" class="bronze" value="${row.bronze}" min="0"></td>
                    <td class="total">${total}</td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    });
}

function updateAllScores() {
    document.querySelectorAll("tr[data-id]").forEach(row => {
        let id = row.dataset.id;
        let gold = row.querySelector(".gold").value;
        let silver = row.querySelector(".silver").value;
        let bronze = row.querySelector(".bronze").value;
        let totalCell = row.querySelector(".total");

        let newTotal = parseInt(gold) + parseInt(silver) + parseInt(bronze);
        totalCell.textContent = newTotal;

        fetch("update_score.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${id}&gold=${gold}&silver=${silver}&bronze=${bronze}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                loadScoreboard();
            } else {
                alert("Update failed: " + data.message);
            }
        });
    });
}

fetch("fetch_scores.php")
    .then(response => response.json())
    .then(data => {
        if (data.length > 0) {
            let eventTitle = `${data[0].event_name} - ${data[0].year}`;
            document.getElementById("eventTitle").textContent = eventTitle;
        }
    })
    .catch(error => console.error("Error fetching event details:", error));

function resetScoreboard() {
    fetch("reset_scoreboard.php", { method: "POST" })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            loadScoreboard();
        }
    });
}

document.addEventListener("DOMContentLoaded", loadScoreboard);
</script>

</body>
</html>
